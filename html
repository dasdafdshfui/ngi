<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLONG Control Panel - Secure Access</title>
    <style>
        /* ════════════════════════════════════════════════════════════════════
           VARIABLES & RESET
        ════════════════════════════════════════════════════════════════════ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --primary-dark: #5568d3; --secondary: #764ba2;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --dark: #1f2937; --light: #f9fafb; --gray: #6b7280; --border: #e5e7eb;
            --shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--dark);
        }

        /* ════════════════════════════════════════════════════════════════════
           LOGIN INTERFACE & UTILITIES
        ════════════════════════════════════════════════════════════════════ */
        #loginScreen {
            background: white; padding: 50px 40px; border-radius: 20px; box-shadow: var(--shadow);
            width: 420px; max-width: 90vw; animation: fadeIn 0.5s ease;
        }
        .login-logo { font-size: 60px; text-align: center; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .login-title { text-align: center; font-size: 28px; font-weight: 700; margin-bottom: 10px; }
        .login-subtitle { text-align: center; color: var(--gray); margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #374151; }
        .form-input { width: 100%; padding: 12px 15px 12px 45px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .input-icon { position: absolute; left: 15px; top: 42px; font-size: 18px; color: var(--gray); }
        .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
        .error-box { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; font-size: 14px; display: none; animation: shake 0.5s; }
        .error-box.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        /* ════════════════════════════════════════════════════════════════════
           DASHBOARD INTERFACE
        ════════════════════════════════════════════════════════════════════ */
        #dashboard { display: none; width: 100vw; height: 100vh; background: var(--light); animation: fadeIn 0.5s; }
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header-title { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-logout { background: transparent; color: white; border: 2px solid white; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-logout:hover { background: white; color: var(--primary); }
        .dashboard-layout { display: flex; height: calc(100vh - 80px); }
        .sidebar { width: 280px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.05); padding: 30px 0; }
        .nav-item { padding: 15px 30px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent; color: var(--gray); font-weight: 500; }
        .nav-item:hover { background: #f3f4f6; color: var(--primary); }
        .nav-item.active { background: linear-gradient(90deg, rgba(102,126,234,0.1), transparent); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .nav-icon { font-size: 20px; }
        .content-area { flex: 1; padding: 40px; overflow-y: auto; }
        .page-section { display: none; }
        .page-section.active { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 32px; font-weight: 700; color: var(--dark); margin-bottom: 10px; }
        .section-desc { color: var(--gray); margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s; }
        .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .card-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--dark); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; } .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .file-list { margin-top: 20px; }
        .file-item { background: var(--light); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; border: 2px solid transparent; }
        .file-item:hover { background: #e5e7eb; transform: translateX(5px); border-color: var(--primary); }
        .file-info { display: flex; align-items: center; gap: 12px; }
        .file-icon { font-size: 24px; }
        .file-name { font-weight: 600; color: var(--dark); } .file-size { font-size: 12px; color: var(--gray); }
        .file-actions { display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 6px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .stat-card.green { border-left-color: var(--success); } .stat-card.orange { border-left-color: var(--warning); }
        .stat-value { font-size: 36px; font-weight: 700; color: var(--dark); }
        .stat-label { color: var(--gray); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; animation: scaleIn 0.3s; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; }
        .code-editor { width: 100%; min-height: 400px; font-family: 'Courier New', monospace; padding: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--dark); color: var(--success); }
        @media (max-width: 768px) { .dashboard-layout { flex-direction: column; } .sidebar { width: 100%; padding: 15px 0; } .content-area { padding: 20px; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-logo">🔐</div>
        <h1 class="login-title">PLONG Control Panel</h1>
        <p class="login-subtitle">Secure Server Management System</p>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label class="form-label">Username</label><span class="input-icon">👤</span>
                <input type="text" class="form-input" id="username" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label><span class="input-icon">🔒</span>
                <input type="password" class="form-input" id="password" required>
            </div>
            <button type="submit" class="btn-login">Access Control Panel</button>
        </form>
        <div id="loginError" class="error-box">❌ Invalid credentials. Access denied.</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="header">
            <div class="header-title"><span>🎮</span><span>PLONG Control Panel</span></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="user-badge" id="userRole"></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="dashboard-layout">
            <div class="sidebar" id="sidebar"></div>
            <div class="content-area">
                <div id="scriptsPage" class="page-section"></div>
                <div id="worldPage" class="page-section"></div>
                <div id="netherPage" class="page-section"></div>
                <div id="endPage" class="page-section"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPT MODAL -->
    <div id="scriptModal" class="modal">
        <div class="modal-box">
            <h2 class="modal-title">Create New Script</h2>
            <div class="form-group"><label class="form-label">Script Name</label><input type="text" class="form-input" id="newScriptName" placeholder="my-script.groovy" style="padding-left: 15px;"></div>
            <div class="form-group"><label class="form-label">Script Type</label><select class="form-input" id="scriptType" style="padding-left: 15px;"><option value="groovy">Groovy (.groovy)</option><option value="js">JavaScript (.js)</option></select></div>
            <div class="form-group"><label class="form-label">Script Content</label><textarea class="code-editor" id="scriptContent">// Your script here</textarea></div>
            <div class="action-buttons"><button class="btn btn-success" onclick="saveScript()">💾 Save Script</button><button class="btn btn-danger" onclick="closeModal()">Cancel</button></div>
        </div>
    </div>

    <script>
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // ⚙️ CONFIGURATION: UPDATE THIS URL TO POINT TO YOUR BACKEND API
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        const API_BASE = 'https://your-plong-api.yourdomain.com/api'; // <-- IMPORTANT!
        
        // GLOBAL STATE
        let currentUser = null;

        // ═══════════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('apiToken');
            const role = localStorage.getItem('userRole');
            if (token && role) {
                currentUser = { role };
                initDashboard();
            }
        });

        // ═══════════════════════════════════════════════════════════════════
        // AUTHENTICATION
        // ═══════════════════════════════════════════════════════════════════
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorBox = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) throw new Error('Invalid credentials');
                
                const data = await response.json();
                localStorage.setItem('apiToken', data.token);
                localStorage.setItem('userRole', data.role);
                currentUser = { role: data.role };
                initDashboard();

            } catch (error) {
                errorBox.classList.add('show');
                setTimeout(() => errorBox.classList.remove('show'), 3000);
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('apiToken');
            localStorage.removeItem('userRole');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
        }

        // ═══════════════════════════════════════════════════════════════════
        // DASHBOARD & UI
        // ═══════════════════════════════════════════════════════════════════
        function initDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            const roleText = currentUser.role === 'SCRIPTS_ADMIN' ? '👨‍💼 Scripts Admin' : '💾 Backup Manager';
            document.getElementById('userRole').textContent = roleText;
            
            generateSidebar();
            
            const initialPage = currentUser.role === 'SCRIPTS_ADMIN' ? 'scriptsPage' : 'worldPage';
            switchPage(document.querySelector(`.nav-item[data-page="${initialPage}"]`));
        }

        function generateSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (currentUser.role === 'SCRIPTS_ADMIN') {
                sidebar.innerHTML = createNavItem('scriptsPage', '📜', 'Scripts Manager');
            } else {
                sidebar.innerHTML = `
                    ${createNavItem('worldPage', '🌍', 'Overworld')}
                    ${createNavItem('netherPage', '🔥', 'Nether')}
                    ${createNavItem('endPage', '🌌', 'The End')}
                `;
            }
        }

        function createNavItem(pageId, icon, text) {
            return `<div class="nav-item" data-page="${pageId}" onclick="switchPage(this)">
                        <span class="nav-icon">${icon}</span><span>${text}</span>
                    </div>`;
        }
        
        function switchPage(element) {
            const pageId = element.getAttribute('data-page');
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
            
            // Load content for the active page
            if (pageId === 'scriptsPage') renderScriptsPage();
            else if (pageId === 'worldPage') renderWorldPage('world');
            else if (pageId === 'netherPage') renderWorldPage('nether');
            else if (pageId === 'endPage') renderWorldPage('end');
        }

        // ═══════════════════════════════════════════════════════════════════
        // API HELPER
        // ═══════════════════════════════════════════════════════════════════
        async function apiFetch(endpoint, options = {}) {
            const token = localStorage.getItem('apiToken');
            const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            
            if (options.body && typeof options.body === 'object') {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
            
            if (response.status === 401 || response.status === 403) {
                logout(); // Token is invalid or expired
                throw new Error('Unauthorized');
            }
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            }
            return response.text();
        }

        // ═══════════════════════════════════════════════════════════════════
        // PAGE RENDERERS
        // ═══════════════════════════════════════════════════════════════════
        async function renderScriptsPage() {
            const page = document.getElementById('scriptsPage');
            page.innerHTML = `
                <h1 class="section-title">📜 Script Manager</h1>
                <p class="section-desc">Manage server-side Groovy and JavaScript scripts</p>
                <div id="statsContainer"></div>
                <div class="card"><h3 class="card-title">Script Actions</h3><div class="action-buttons">
                    <button class="btn btn-primary" onclick="showScriptModal()">➕ New Script</button>
                    <button class="btn btn-success" onclick="uploadScript()">📤 Upload Script</button>
                    <button class="btn btn-warning" onclick="reloadAllScripts()">🔄 Reload All</button>
                </div></div>
                <div class="card"><h3 class="card-title">Loaded Scripts</h3><div class="file-list" id="scriptsList"><div class="spinner"></div></div></div>
            `;
            
            try {
                const scripts = await apiFetch('/scripts/list');
                const groovyCount = scripts.filter(s => s.name.endsWith('.groovy')).length;
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value">${scripts.length}</div><div class="stat-label">Total</div></div>
                        <div class="stat-card green"><div class="stat-value">${groovyCount}</div><div class="stat-label">Groovy</div></div>
                        <div class="stat-card orange"><div class="stat-value">${scripts.length - groovyCount}</div><div class="stat-label">JavaScript</div></div>
                    </div>`;
                
                document.getElementById('scriptsList').innerHTML = scripts.map(s => `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">${s.name.endsWith('.groovy') ? '💎' : '📒'}</span>
                            <div><div class="file-name">${s.name}</div><div class="file-size">${s.size}</div></div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-danger" onclick="deleteScript('${s.name}')">Delete</button>
                        </div>
                    </div>`).join('') || '<p>No scripts found.</p>';
            } catch (e) {
                document.getElementById('scriptsList').innerHTML = '<p class="error-box show">Could not load scripts.</p>';
            }
        }

        async function renderWorldPage(worldType) {
            const pageId = `${worldType}Page`;
            const page = document.getElementById(pageId);
            const title = worldType.charAt(0).toUpperCase() + worldType.slice(1);
            const icon = { world: '🌍', nether: '🔥', end: '🌌' }[worldType];
            
            page.innerHTML = `
                <h1 class="section-title">${icon} ${title} Backup</h1>
                <p class="section-desc">Manage files for the ${title} dimension</p>
                <div class="card"><h3 class="card-title">Quick Actions</h3><div class="action-buttons">
                    <button class="btn btn-success" onclick="downloadWorld('${worldType}')">⬇️ Download Full Backup</button>
                </div></div>
                <div class="card"><h3 class="card-title">${title} Files</h3><div class="file-list" id="${worldType}FileList"><div class="spinner"></div></div></div>
            `;

            try {
                const files = await apiFetch(`/worlds/${worldType}/files`);
                document.getElementById(`${worldType}FileList`).innerHTML = files.map(f => `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon">${f.isDirectory ? '📁' : '📄'}</span>
                            <div><div class="file-name">${f.name}</div><div class="file-size">${f.size || 'Directory'}</div></div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small btn-success" onclick="downloadFile('${worldType}', '${f.name}')">Download</button>
                        </div>
                    </div>`).join('') || '<p>No files found.</p>';
            } catch (e) {
                document.getElementById(`${worldType}FileList`).innerHTML = '<p class="error-box show">Could not load files.</p>';
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // ACTION HANDLERS
        // ═══════════════════════════════════════════════════════════════════
        function showScriptModal() { document.getElementById('scriptModal').classList.add('show'); }
        function closeModal() { document.getElementById('scriptModal').classList.remove('show'); }
        
        async function saveScript() {
            const name = document.getElementById('newScriptName').value;
            const type = document.getElementById('scriptType').value;
            const content = document.getElementById('scriptContent').value;
            const filename = name.includes('.') ? name : `${name}.${type}`;

            try {
                await apiFetch('/scripts/create', { method: 'POST', body: { filename, content } });
                closeModal();
                renderScriptsPage();
            } catch (e) { alert('Failed to save script.'); }
        }

        async function deleteScript(name) {
            if (!confirm(`Delete script "${name}"? This is permanent.`)) return;
            try {
                await apiFetch(`/scripts/delete/${name}`, { method: 'DELETE' });
                renderScriptsPage();
            } catch (e) { alert('Failed to delete script.'); }
        }
        
        async function reloadAllScripts() {
            try {
                await apiFetch('/scripts/reload', { method: 'POST' });
                alert('All scripts have been reloaded on the server.');
            } catch(e) { alert('Failed to reload scripts.'); }
        }

        function uploadScript() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.groovy,.js';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('script', file);
                try {
                    await apiFetch('/scripts/upload', { method: 'POST', body: formData, headers: {} }); // Let browser set Content-Type for FormData
                    renderScriptsPage();
                } catch (e) { alert('Upload failed.'); }
            };
            input.click();
        }

        function downloadWorld(worldType) {
            window.location.href = `${API_BASE}/worlds/${worldType}/download?token=${localStorage.getItem('apiToken')}`;
        }

        function downloadFile(worldType, filename) {
            window.location.href = `${API_BASE}/worlds/${worldType}/file/${encodeURIComponent(filename)}?token=${localStorage.getItem('apiToken')}`;
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    </script>
</body>
</html>
